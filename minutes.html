<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI議事録作成ツール v7 (社員認証機能付き)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .status-dot-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-white text-gray-800 p-4">

    <!-- ログイン画面 -->
    <div id="loginContainer" class="w-full max-w-md mx-auto mt-20 text-center">
        <h1 class="text-3xl font-bold text-gray-900">AI議事録作成ツール</h1>
        <p class="text-gray-600 mt-4">会社のGoogleアカウントでログインしてください。</p>
        <div id="g_id_onload"
             data-client_id="608279178775-sqmc0n5qimmlblnenfbtin66knofd7go.apps.googleusercontent.com"
             data-callback="handleSignIn"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin mt-8"
             data-type="standard"
             data-shape="rectangular"
             data-theme="outline"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>
        <p id="authError" class="hidden mt-4 text-red-500 font-semibold">このアカウントではアクセスできません。会社のドメインを持つアカウントでログインしてください。</p>
    </div>

    <!-- メインアプリ (初期状態では非表示) -->
    <div id="mainAppContainer" class="hidden w-full max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        <!-- ヘッダー -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI議事録作成ツール</h1>
            <p class="text-gray-600 mt-2">長時間の会議にも対応した、シンプルな文字起こし・議事録作成ツールです。</p>
        </header>

        <!-- ステータスとコントロール -->
        <div class="flex items-center justify-between gap-4 p-4 bg-gray-100 rounded-lg">
            <div class="flex items-center gap-4">
                <button id="startButton" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400">
                    <i class="fas fa-microphone-alt mr-2"></i>録音開始
                </button>
                <button id="stopButton" class="hidden px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <i class="fas fa-stop-circle mr-2"></i>録音停止
                </button>
            </div>
            <div id="status" class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-200 text-gray-700 font-medium">
                <div class="status-dot w-3 h-3 bg-gray-400 rounded-full"></div>
                <span>待機中</span>
            </div>
        </div>

        <!-- 文字起こし結果 -->
        <div class="relative">
            <label for="transcriptionText" class="block text-lg font-medium mb-2">文字起こし結果</label>
            <textarea id="transcriptionText" class="w-full h-64 p-4 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ここにリアルタイムで文字起こしが表示されます..."></textarea>
        </div>

        <!-- 議事録生成フォーム (録音停止後に表示) -->
        <div id="generationForm" class="hidden space-y-4">
            <div>
                <label for="attendees" class="block text-lg font-medium mb-2">会議参加者 (コンマ区切り)</label>
                <input type="text" id="attendees" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="例: 山田太郎, 鈴木花子">
            </div>
            <button id="generateButton" class="w-full px-6 py-4 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-gray-400 flex items-center justify-center">
                <i class="fas fa-file-alt mr-2"></i>AIで議事録を作成
            </button>
        </div>

        <!-- AI生成議事録 (生成後に表示) -->
        <div id="minutesContainer" class="hidden space-y-4">
             <div class="flex justify-between items-center">
                <h2 class="text-xl md:text-2xl font-bold">AI生成議事録</h2>
                <button id="resetButton" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    <i class="fas fa-sync-alt mr-2"></i>リセット
                </button>
            </div>
            <div id="loadingSpinner" class="hidden flex items-center justify-center p-8">
                <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
                <p class="ml-4 text-lg">AIが議事録を生成中です...</p>
            </div>
            <div class="relative">
                <textarea id="generatedMinutesText" class="w-full h-96 p-4 border-2 border-green-200 bg-green-50 rounded-lg" readonly></textarea>
                <button id="copyButton" class="absolute top-3 right-3 px-3 py-1.5 bg-gray-200 text-gray-600 rounded-md hover:bg-gray-300" title="議事録をコピー">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 設定 ---
        const GEMINI_API_KEY = "AIzaSyDOd05QUw1cvYHaWKBbFUjeyGGill6bApQ";
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ 以下のドメインを、貴社のGoogle Workspaceドメインに変更してください ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        const ALLOWED_DOMAIN = "lct.jp"; 

        // --- DOM要素 ---
        const loginContainer = document.getElementById('loginContainer');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const authError = document.getElementById('authError');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const generateButton = document.getElementById('generateButton');
        const resetButton = document.getElementById('resetButton');
        const transcriptionText = document.getElementById('transcriptionText');
        const attendees = document.getElementById('attendees');
        const statusElement = document.getElementById('status');
        const generationForm = document.getElementById('generationForm');
        const minutesContainer = document.getElementById('minutesContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const generatedMinutesText = document.getElementById('generatedMinutesText');
        const copyButton = document.getElementById('copyButton');

        // --- 変数 ---
        let recognition;
        let isRecording = false;
        let finalTranscript = '';
        let recordingStartTime;

        // --- 認証機能 ---
        function handleSignIn(response) {
            const userObject = jwt_decode(response.credential);
            console.log("ログイン試行:", userObject.email);

            if (userObject.email.endsWith('@' + ALLOWED_DOMAIN)) {
                console.log("認証成功");
                loginContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
            } else {
                console.log("認証失敗: ドメインが一致しません");
                authError.classList.remove('hidden');
                // 不正なドメインのユーザーが自動ログインしないようにする
                google.accounts.id.disableAutoSelect();
            }
        }

        // --- 初期化 ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = true;
            recognition.continuous = true;

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let currentFinalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        currentFinalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                if (currentFinalTranscript) {
                    finalTranscript += currentFinalTranscript + '\n';
                }
                transcriptionText.value = finalTranscript + interimTranscript;
                transcriptionText.scrollTop = transcriptionText.scrollHeight;
            };
            recognition.onstart = () => updateStatus('recording');
            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                } else {
                    updateStatus('idle');
                }
            };
            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error, event.message);
                let userMessage = `エラー: ${event.error}`;
                if (event.error === 'not-allowed') {
                    userMessage = 'マイクの使用が許可されていません。';
                    transcriptionText.value = 'マイクへのアクセスがブロックされました。\n\nブラウザやOSのマイク設定、またこのツールを埋め込んでいるサイトのiframe設定（allow="microphone"）を確認してください。';
                }
                updateStatus('error', userMessage);
                isRecording = false;
            };
        } else {
            startButton.disabled = true;
            updateStatus('error', 'ブラウザ非対応');
        }

        // --- ボタン操作 ---
        startButton.addEventListener('click', () => {
            isRecording = true;
            finalTranscript = '';
            transcriptionText.value = '';
            recordingStartTime = new Date();
            recognition.start();
            startButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            generationForm.classList.add('hidden');
            minutesContainer.classList.add('hidden');
        });

        stopButton.addEventListener('click', () => {
            isRecording = false;
            recognition.stop();
            stopButton.classList.add('hidden');
            startButton.classList.remove('hidden');
            if (transcriptionText.value.trim()) {
                generationForm.classList.remove('hidden');
            }
        });
        
        resetButton.addEventListener('click', () => {
            transcriptionText.value = '';
            attendees.value = '';
            generatedMinutesText.value = '';
            finalTranscript = '';
            minutesContainer.classList.add('hidden');
            generationForm.classList.add('hidden');
            startButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
            updateStatus('idle');
        });

        generateButton.addEventListener('click', async () => {
            const transcript = transcriptionText.value;
            const participantList = attendees.value;
            if (!transcript.trim()) {
                alert('文字起こしされたテキストがありません。');
                return;
            }
            minutesContainer.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            generatedMinutesText.value = '';
            generateButton.disabled = true;

            const formattedStartTime = recordingStartTime.toLocaleString('ja-JP', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });

            const prompt = `あなたは優秀なアシスタントです。以下の会議情報と文字起こしテキストを基に、ビジネスで通用する議事録を作成してください。

# 会議情報
- 日時: ${formattedStartTime}
- 参加者: ${participantList || '記載なし'}

# 文字起こしテキスト
---
${transcript}
---

# 生成する議事録のフォーマット
- **会議の概要**:
- **決定事項**:
- **アクションアイテム (担当者、期限を明確に)**:
- **議論の詳細**:

# 注意事項
- 上記のフォーマットに厳密に従ってください。`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || 'APIからの応答エラー');
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    generatedMinutesText.value = result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('AIからの応答がありませんでした。');
                }
            } catch (error) {
                generatedMinutesText.value = '議事録の生成中にエラーが発生しました。\n' + error.message;
            } finally {
                loadingSpinner.classList.add('hidden');
                generateButton.disabled = false;
                generationForm.classList.add('hidden');
            }
        });
        
        copyButton.addEventListener('click', () => {
            if (generatedMinutesText.value) {
                generatedMinutesText.select();
                document.execCommand('copy');
                alert('議事録をコピーしました。');
            }
        });

        function updateStatus(status, message = '') {
            const dot = statusElement.querySelector('.status-dot');
            const text = statusElement.querySelector('span');
            dot.className = 'status-dot w-3 h-3 rounded-full';
            switch (status) {
                case 'recording':
                    dot.classList.add('bg-green-500', 'status-dot-pulse');
                    text.textContent = '録音中...';
                    break;
                case 'error':
                    dot.classList.add('bg-red-500');
                    text.textContent = message;
                    break;
                case 'idle':
                default:
                    dot.classList.add('bg-gray-400');
                    text.textContent = '待機中';
                    break;
            }
        }
    </script>
</body>
</html>
