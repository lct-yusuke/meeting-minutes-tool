<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­°äº‹éŒ²ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section-title {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input[type="text"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .recording-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .btn-success {
            background: #43a047;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #388e3c;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-recording {
            background: #ffebee;
            color: #c62828;
            animation: pulse 2s infinite;
        }

        .status-idle {
            background: #f5f5f5;
            color: #666;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .recording-timer {
            font-size: 1.1em;
            font-weight: 600;
            color: #c62828;
        }

        .transcript-box {
            min-height: 150px;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
            line-height: 1.6;
            color: #333;
            max-height: 300px;
            overflow-y: auto;
        }

        .minutes-box {
            background: white;
            padding: 20px;
            border-radius: 5px;
            border: 2px solid #e0e0e0;
            min-height: 200px;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1em;
            max-height: 500px;
            overflow-y: auto;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background: #43a047;
        }

        .status-dot.disconnected {
            background: #e53935;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-weight: 500;
            margin: 10px 0;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .permission-info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .clear-btn {
            background: #ff5252;
            color: white;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .clear-btn:hover {
            background: #f44336;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ è­°äº‹éŒ²ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="permission-info" id="permissionInfo">
            <strong>ğŸ“¢ åˆå›åˆ©ç”¨æ™‚ã®æ³¨æ„:</strong><br>
            â€¢ éŒ²éŸ³é–‹å§‹æ™‚ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒã‚¤ã‚¯ã®ä½¿ç”¨è¨±å¯ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™<br>
            â€¢ ã€Œè¨±å¯ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„<br>
            â€¢ Google Sitesã§ã¯ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</h2>
            <div class="input-group">
                <div class="input-field">
                    <label for="ourCompany">è‡ªç¤¾å</label>
                    <input type="text" id="ourCompany" value="ãƒªã‚¯ãƒˆ" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ABC">
                </div>
                <div class="input-field">
                    <label for="theirCompany">å…ˆæ–¹ä¼šç¤¾å</label>
                    <input type="text" id="theirCompany" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾XYZ">
                </div>
                <div class="input-field">
                    <label for="ourAttendees">è‡ªç¤¾å‚åŠ è€…</label>
                    <input type="text" id="ourAttendees" placeholder="ä¾‹: å±±ç”°å¤ªéƒ, ä½è—¤èŠ±å­">
                </div>
                <div class="input-field">
                    <label for="theirAttendees">å…ˆæ–¹å‚åŠ è€…</label>
                    <input type="text" id="theirAttendees" placeholder="ä¾‹: ç”°ä¸­ä¸€éƒ, éˆ´æœ¨æ¬¡éƒ">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ¤ éŸ³å£°éŒ²éŸ³</h2>
            <div class="warning-message" id="browserWarning" style="display: none;">
                âš ï¸ éŸ³å£°èªè­˜ã¯Chromeãƒ–ãƒ©ã‚¦ã‚¶ã§æœ€é©ã«å‹•ä½œã—ã¾ã™
            </div>
            <div class="recording-controls">
                <button id="startBtn" class="btn btn-primary">
                    <span>â—</span> éŒ²éŸ³é–‹å§‹
                </button>
                <button id="stopBtn" class="btn btn-secondary" disabled>
                    <span>â– </span> éŒ²éŸ³åœæ­¢
                </button>
                <span id="status" class="status status-idle">å¾…æ©Ÿä¸­</span>
                <span id="recordingTimer" class="recording-timer" style="display: none;">00:00:00</span>
                <button id="clearBtn" class="btn clear-btn">
                    <span>ğŸ—‘ï¸</span> ã‚¯ãƒªã‚¢
                </button>
            </div>
            <div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">
                <span>æ–‡å­—èµ·ã“ã—å†…å®¹ (æ–‡å­—æ•°: <span id="charCount">0</span>)</span>
            </div>
            <div class="transcript-box" id="transcript">
                ã“ã“ã«æ–‡å­—èµ·ã“ã—ã•ã‚ŒãŸå†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">âš™ï¸ Googleèªè¨¼</h2>
            <div class="auth-status">
                <span class="status-dot disconnected" id="authStatusDot"></span>
                <span id="authStatusText">Googleæœªèªè¨¼</span>
            </div>
            <button id="authorizeBtn" class="btn btn-primary">
                Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <button id="signoutBtn" class="btn btn-secondary" style="display: none;">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
            <div class="error-message message" id="authError"></div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“„ è­°äº‹éŒ²ç”Ÿæˆ</h2>
            <button id="generateBtn" class="btn btn-primary" disabled>
                <span>âœ¨</span> è­°äº‹éŒ²ã‚’ç”Ÿæˆ
            </button>
            <div class="loading" id="generateLoading">
                <div class="spinner"></div>
                <span>è­°äº‹éŒ²ã‚’ç”Ÿæˆä¸­...</span>
            </div>
            <div class="error-message message" id="errorMessage"></div>
            <div class="success-message message" id="successMessage"></div>
            <div class="minutes-box" id="minutes" style="margin-top: 20px; display: none;">
                ç”Ÿæˆã•ã‚ŒãŸè­°äº‹éŒ²ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
            </div>
        </div>

        <div class="section" id="uploadSection" style="display: none;">
            <h2 class="section-title">â˜ï¸ Google Docsã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <button id="uploadBtn" class="btn btn-success">
                <span>ğŸ“¤</span> Google Docsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>
            <div class="loading" id="uploadLoading">
                <div class="spinner"></div>
                <span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š - å®Ÿéš›ã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // ã“ã“ã«Gemini API Keyã‚’è¨­å®š
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // ã“ã“ã«Google OAuth Client IDã‚’è¨­å®š
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let recognition = null;
        let isRecording = false;
        let fullTranscript = '';
        let interimTranscript = '';
        let accessToken = null;
        let tokenClient = null;
        let recordingStartTime = null;
        let recordingTimer = null;

        // DOMè¦ç´ 
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const generateBtn = document.getElementById('generateBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const authorizeBtn = document.getElementById('authorizeBtn');
        const signoutBtn = document.getElementById('signoutBtn');
        const clearBtn = document.getElementById('clearBtn');
        const transcriptDiv = document.getElementById('transcript');
        const minutesDiv = document.getElementById('minutes');
        const statusSpan = document.getElementById('status');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const authError = document.getElementById('authError');
        const authStatusDot = document.getElementById('authStatusDot');
        const authStatusText = document.getElementById('authStatusText');
        const recordingTimerSpan = document.getElementById('recordingTimer');
        const charCountSpan = document.getElementById('charCount');
        const browserWarning = document.getElementById('browserWarning');

        // ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚§ãƒƒã‚¯
        function checkBrowser() {
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            if (!isChrome) {
                browserWarning.style.display = 'block';
            }
        }

        // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    showError('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
                    startBtn.disabled = true;
                    return false;
                }

                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ja-JP';
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    console.log('éŸ³å£°èªè­˜é–‹å§‹');
                    isRecording = true;
                    statusSpan.textContent = 'éŒ²éŸ³ä¸­...';
                    statusSpan.className = 'status status-recording';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    recordingStartTime = Date.now();
                    startRecordingTimer();
                    document.getElementById('permissionInfo').style.display = 'none';
                };

                recognition.onend = () => {
                    console.log('éŸ³å£°èªè­˜çµ‚äº†');
                    if (isRecording) {
                        // éŒ²éŸ³ä¸­ã«èªè­˜ãŒåœæ­¢ã—ãŸå ´åˆã¯è‡ªå‹•çš„ã«å†é–‹
                        setTimeout(() => {
                            if (isRecording) {
                                try {
                                    recognition.start();
                                } catch (e) {
                                    console.error('éŸ³å£°èªè­˜ã®å†é–‹ã«å¤±æ•—:', e);
                                }
                            }
                        }, 500);
                    } else {
                        // éŒ²éŸ³åœæ­¢æ™‚ã®å‡¦ç†
                        statusSpan.textContent = 'å¾…æ©Ÿä¸­';
                        statusSpan.className = 'status status-idle';
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        stopRecordingTimer();
                        
                        if (fullTranscript.trim()) {
                            generateBtn.disabled = false;
                        }
                    }
                };

                recognition.onresult = (event) => {
                    interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        
                        if (event.results[i].isFinal) {
                            fullTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    updateTranscriptDisplay();
                };

                recognition.onerror = (event) => {
                    console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                    
                    if (event.error === 'not-allowed') {
                        showError('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                        stopRecording();
                    } else if (event.error === 'no-speech') {
                        console.log('ç„¡éŸ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ');
                    } else if (event.error === 'network') {
                        showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    }
                };

                return true;
            } catch (error) {
                console.error('éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                return false;
            }
        }

        // æ–‡å­—èµ·ã“ã—è¡¨ç¤ºã®æ›´æ–°
        function updateTranscriptDisplay() {
            transcriptDiv.textContent = fullTranscript + interimTranscript;
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
            charCountSpan.textContent = (fullTranscript + interimTranscript).length;
        }

        // éŒ²éŸ³ã‚¿ã‚¤ãƒãƒ¼
        function startRecordingTimer() {
            recordingTimerSpan.style.display = 'inline';
            recordingTimer = setInterval(updateRecordingTimer, 1000);
        }

        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            recordingTimerSpan.style.display = 'none';
        }

        function updateRecordingTimer() {
            if (!recordingStartTime) return;
            
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            recordingTimerSpan.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // éŒ²éŸ³åœæ­¢
        function stopRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
        }

        // Google APIåˆæœŸåŒ–
        function initGoogleAPI() {
            if (typeof google === 'undefined' || !google.accounts) {
                console.error('Google APIãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                showAuthError('Google APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file',
                    callback: async (response) => {
                        if (response.error !== undefined) {
                            showAuthError('Googleèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.error);
                            return;
                        }
                        accessToken = response.access_token;
                        
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ã‹ãƒã‚§ãƒƒã‚¯
                        try {
                            const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`
                                }
                            });
                            const userData = await userInfo.json();
                            
                            // ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿è¨±å¯ï¼ˆä¾‹ï¼š@yourcompany.comï¼‰
                            const ALLOWED_DOMAINS = ['yourcompany.com', 'gmail.com']; // è¨±å¯ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®š
                            const emailDomain = userData.email.split('@')[1];
                            
                            if (!ALLOWED_DOMAINS.includes(emailDomain)) {
                                showAuthError('ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚');
                                accessToken = null;
                                return;
                            }
                            
                            updateAuthStatus(true);
                            showSuccess(`Googleèªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ (${userData.email})`);
                        } catch (error) {
                            console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                            showAuthError('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
                    },
                    hosted_domain: 'yourcompany.com' // ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«åˆ¶é™ã™ã‚‹å ´åˆ
                });
            } catch (error) {
                console.error('Google APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthError('Google APIã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // èªè¨¼çŠ¶æ…‹ã®æ›´æ–°
        function updateAuthStatus(isAuthenticated) {
            if (isAuthenticated) {
                authStatusDot.className = 'status-dot connected';
                authStatusText.textContent = 'Googleèªè¨¼æ¸ˆã¿';
                authorizeBtn.style.display = 'none';
                signoutBtn.style.display = 'inline-block';
                if (minutesDiv.textContent && minutesDiv.textContent !== 'ç”Ÿæˆã•ã‚ŒãŸè­°äº‹éŒ²ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...') {
                    document.getElementById('uploadSection').style.display = 'block';
                }
            } else {
                authStatusDot.className = 'status-dot disconnected';
                authStatusText.textContent = 'Googleæœªèªè¨¼';
                authorizeBtn.style.display = 'inline-block';
                signoutBtn.style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
                accessToken = null;
            }
        }

        // Gemini APIã§è­°äº‹éŒ²ç”Ÿæˆ
        async function generateMinutes() {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                showError('Gemini API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            if (!fullTranscript.trim()) {
                showError('æ–‡å­—èµ·ã“ã—ã•ã‚ŒãŸå†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            document.getElementById('generateLoading').classList.add('active');
            generateBtn.disabled = true;
            hideMessages();

            const ourCompany = document.getElementById('ourCompany').value || 'ãƒªã‚¯ãƒˆ';
            const theirCompany = document.getElementById('theirCompany').value || 'å…ˆæ–¹';
            const ourAttendees = document.getElementById('ourAttendees').value || 'è‡ªç¤¾å‚åŠ è€…';
            const theirAttendees = document.getElementById('theirAttendees').value || 'å…ˆæ–¹å‚åŠ è€…';

            const prompt = `
ä»¥ä¸‹ã®ä¼šè­°ã®æ–‡å­—èµ·ã“ã—ã‹ã‚‰è­°äº‹éŒ²ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ä¼šè­°æƒ…å ±ã€‘
æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}
è‡ªç¤¾: ${ourCompany}
å…ˆæ–¹: ${theirCompany}
è‡ªç¤¾å‚åŠ è€…: ${ourAttendees}
å…ˆæ–¹å‚åŠ è€…: ${theirAttendees}

ã€æ–‡å­—èµ·ã“ã—å†…å®¹ã€‘
${fullTranscript}

ã€è­°äº‹éŒ²å½¢å¼ã€‘
ä»¥ä¸‹ã®å½¢å¼ã§è­°äº‹éŒ²ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

1. ä¼šè­°æ¦‚è¦
   - æ—¥æ™‚
   - å‚åŠ è€…ï¼ˆè‡ªç¤¾ãƒ»å…ˆæ–¹ï¼‰
   - è­°é¡Œ

2. è­°è«–å†…å®¹ï¼ˆè¦ç‚¹ã‚’ç®‡æ¡æ›¸ãã§ï¼‰

3. æ±ºå®šäº‹é …
   - æ˜ç¢ºã«æ±ºå®šã•ã‚ŒãŸäº‹é …ã‚’ç®‡æ¡æ›¸ãã§è¨˜è¼‰
   - å„é …ç›®ã¯å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªå†…å®¹ã«ã™ã‚‹

4. ãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³
   - èª°ãŒï¼ˆæ‹…å½“è€…åï¼‰
   - ã„ã¤ã¾ã§ã«ï¼ˆå…·ä½“çš„ãªæœŸé™ï¼‰
   - ä½•ã‚’ã™ã‚‹ã‹ï¼ˆå…·ä½“çš„ãªè¡Œå‹•ï¼‰
   - å„ªå…ˆåº¦ï¼ˆé«˜/ä¸­/ä½ï¼‰

5. ä»Šå¾Œã®äºˆå®š
   - æ¬¡å›ä¼šè­°ã®äºˆå®š
   - ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

6. å‚™è€ƒãƒ»è£œè¶³äº‹é …
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 4096,
                        }
                    }),
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const minutes = data.candidates[0].content.parts[0].text;
                    minutesDiv.textContent = minutes;
                    minutesDiv.style.display = 'block';
                    showSuccess('è­°äº‹éŒ²ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                    
                    if (accessToken) {
                        document.getElementById('uploadSection').style.display = 'block';
                    }
                } else {
                    throw new Error('è­°äº‹éŒ²ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                console.error('è­°äº‹éŒ²ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                document.getElementById('generateLoading').classList.remove('active');
                generateBtn.disabled = false;
            }
        }

        // Google Docsã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadToGoogleDocs() {
            if (!accessToken) {
                showError('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                return;
            }

            const minutes = minutesDiv.textContent;
            if (!minutes || minutes === 'ç”Ÿæˆã•ã‚ŒãŸè­°äº‹éŒ²ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...') {
                showError('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹è­°äº‹éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            document.getElementById('uploadLoading').classList.add('active');
            uploadBtn.disabled = true;
            hideMessages();

            try {
                // Google Docs APIã‚’ä½¿ç”¨ã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
                const createResponse = await fetch('https://docs.googleapis.com/v1/documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: `è­°äº‹éŒ²_${new Date().toLocaleString('ja-JP').replace(/[/:]/g, '-')}`
                    }),
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error?.message || 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const doc = await createResponse.json();
                const documentId = doc.documentId;

                // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å†…å®¹ã‚’æŒ¿å…¥
                const updateResponse = await fetch(`https://docs.googleapis.com/v1/documents/${documentId}:batchUpdate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requests: [{
                            insertText: {
                                location: { index: 1 },
                                text: minutes
                            }
                        }]
                    }),
                });

                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.error?.message || 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                showSuccess(`è­°äº‹éŒ²ã‚’Google Docsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚<br><a href="https://docs.google.com/document/d/${documentId}/edit" target="_blank" style="color: #1976d2;">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ã</a>`);
            } catch (error) {
                showError('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                document.getElementById('uploadLoading').classList.remove('active');
                uploadBtn.disabled = false;
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showError(message) {
            errorMessage.innerHTML = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            successMessage.innerHTML = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            authError.style.display = 'none';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        startBtn.addEventListener('click', async () => {
            console.log('éŒ²éŸ³é–‹å§‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            if (!recognition) {
                showError('éŸ³å£°èªè­˜ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                // ãƒã‚¤ã‚¯ã®è¨±å¯ã‚’æ˜ç¤ºçš„ã«è¦æ±‚
                await navigator.mediaDevices.getUserMedia({ audio: true });
                recognition.start();
            } catch (error) {
                console.error('éŒ²éŸ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                if (error.name === 'NotAllowedError') {
                    showError('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                } else if (error.name === 'NotFoundError') {
                    showError('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹
