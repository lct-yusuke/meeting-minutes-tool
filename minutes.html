<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI議事録作成ツール v7 (社員認証機能付き)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Identity & API Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .status-dot-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-white text-gray-800 p-4">

    <!-- ログイン画面 -->
    <div id="loginContainer" class="w-full max-w-md mx-auto mt-20 text-center">
        <h1 class="text-3xl font-bold text-gray-900">AI議事録作成ツール</h1>
        <p class="text-gray-600 mt-4">会社のGoogleアカウントでログインしてください。</p>
        <div id="g_id_onload"
             data-client_id="608279178775-sqmc0n5qimmlblnenfbtin66knofd7go.apps.googleusercontent.com"
             data-callback="handleSignIn"
             data-auto_prompt="true">
        </div>
        <div class="g_id_signin mt-8"
             data-type="standard"
             data-shape="rectangular"
             data-theme="outline"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>
        <p id="authError" class="hidden mt-4 text-red-500 font-semibold">このアカウントではアクセスできません。会社のドメインを持つアカウントでログインしてください。</p>
    </div>

    <!-- メインアプリ (初期状態では非表示) -->
    <div id="mainAppContainer" class="hidden w-full max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        <!-- ヘッダー -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI議事録作成ツール</h1>
            <p class="text-gray-600 mt-2">会議の音声をAIが解析し、高精度な議事録を自動で作成・管理するツールです。</p>
        </header>

        <!-- ステータスとコントロール -->
        <div class="flex items-center justify-between gap-4 p-4 bg-gray-100 rounded-lg">
            <div class="flex items-center gap-4">
                <button id="startButton" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400">
                    <i class="fas fa-microphone-alt mr-2"></i>録音開始
                </button>
                <button id="stopButton" class="hidden px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <i class="fas fa-stop-circle mr-2"></i>録音停止
                </button>
            </div>
            <div id="status" class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-200 text-gray-700 font-medium">
                <div class="status-dot w-3 h-3 bg-gray-400 rounded-full"></div>
                <span>待機中</span>
            </div>
        </div>

        <!-- 文字起こし結果 -->
        <div class="relative">
            <label for="transcriptionText" class="block text-lg font-medium mb-2">文字起こし結果</label>
            <textarea id="transcriptionText" class="w-full h-64 p-4 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ここにリアルタイムで文字起こしが表示されます..."></textarea>
        </div>

        <!-- 議事録生成フォーム (録音停止後に表示) -->
        <div id="generationForm" class="hidden space-y-4">
            <div>
                <label for="clientCompany" class="block text-lg font-medium mb-2">相手の会社名</label>
                <input type="text" id="clientCompany" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="例: 株式会社サンプル">
            </div>
            <div>
                <label for="clientAttendees" class="block text-lg font-medium mb-2">相手の会社の参加者 (コンマ区切り)</label>
                <input type="text" id="clientAttendees" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="例: 鈴木花子">
            </div>
            <div>
                <label for="ourAttendees" class="block text-lg font-medium mb-2">自社(リクト)の参加者 (コンマ区切り)</label>
                <input type="text" id="ourAttendees" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="例: 山田太郎">
            </div>
            <button id="generateButton" class="w-full px-6 py-4 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:bg-gray-400 flex items-center justify-center">
                <i class="fas fa-file-alt mr-2"></i>AIで議事録を作成
            </button>
        </div>

        <!-- AI生成議事録 (生成後に表示) -->
        <div id="minutesContainer" class="hidden space-y-4">
             <div class="flex justify-between items-center">
                <h2 class="text-xl md:text-2xl font-bold">AI生成議事録</h2>
                <button id="resetButton" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    <i class="fas fa-sync-alt mr-2"></i>リセット
                </button>
            </div>
            <div id="loadingSpinner" class="hidden flex items-center justify-center p-8">
                <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
                <p class="ml-4 text-lg">AIが議事録を生成中です...</p>
            </div>
            <div class="relative">
                <textarea id="generatedMinutesText" class="w-full h-96 p-4 border-2 border-green-200 bg-green-50 rounded-lg" readonly></textarea>
                <div class="absolute top-3 right-3 flex flex-col gap-2">
                    <button id="copyButton" class="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-md hover:bg-gray-300" title="議事録をコピー">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button id="sendToGoogleDocsButton" class="hidden px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600" title="Googleドキュメントに送信">
                        <i class="fab fa-google-drive"></i>
                    </button>
                </div>
            </div>
            <div id="google-docs-feedback" class="text-center mt-2"></div>
        </div>
    </div>

    <script>
        // --- 設定 ---
        const GEMINI_API_KEY = "AIzaSyDOd05QUw1cvYHaWKBbFUjeyGGill6bApQ";
        const ALLOWED_DOMAIN = "lct.jp"; 
        const GAPI_CLIENT_ID = "608279178775-sqmc0n5qimmlblnenfbtin66knofd7go.apps.googleusercontent.com";
        const GAPI_DISCOVERY_DOCS = ["https://docs.googleapis.com/$discovery/rest?version=v1"];
        const GAPI_SCOPES = "https://www.googleapis.com/auth/documents";

        // --- DOM要素 ---
        const loginContainer = document.getElementById('loginContainer');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const authError = document.getElementById('authError');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const generateButton = document.getElementById('generateButton');
        const resetButton = document.getElementById('resetButton');
        const transcriptionText = document.getElementById('transcriptionText');
        const clientCompany = document.getElementById('clientCompany');
        const clientAttendees = document.getElementById('clientAttendees');
        const ourAttendees = document.getElementById('ourAttendees');
        const statusElement = document.getElementById('status');
        const generationForm = document.getElementById('generationForm');
        const minutesContainer = document.getElementById('minutesContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const generatedMinutesText = document.getElementById('generatedMinutesText');
        const copyButton = document.getElementById('copyButton');
        const sendToGoogleDocsButton = document.getElementById('sendToGoogleDocsButton');
        const googleDocsFeedback = document.getElementById('google-docs-feedback');

        // --- 変数 ---
        let recognition;
        let isRecording = false;
        let finalTranscript = '';
        let recordingStartTime;
        let gapiInited = false;
        let tokenClient;

        // --- 認証機能 ---
        window.handleSignIn = function(response) {
            try {
                const credential = response.credential;
                const payloadBase64Url = credential.split('.')[1];
                const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(payloadBase64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const userObject = JSON.parse(jsonPayload);

                if (userObject.email && userObject.email.endsWith('@' + ALLOWED_DOMAIN)) {
                    loginContainer.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                } else {
                    authError.classList.remove('hidden');
                    google.accounts.id.disableAutoSelect();
                }
            } catch (error) {
                console.error("サインイン処理中にエラー:", error);
                authError.textContent = "ログイン処理中にエラーが発生しました。";
                authError.classList.remove('hidden');
            }
        };

        // --- Google Docs API連携 ---
        window.gapiLoaded = function() {
            gapi.load('client', initializeGapiClient);
        };
        async function initializeGapiClient() {
            await gapi.client.init({ discoveryDocs: GAPI_DISCOVERY_DOCS });
            gapiInited = true;
        }
        
        sendToGoogleDocsButton.addEventListener('click', () => {
             tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GAPI_CLIENT_ID,
                scope: GAPI_SCOPES,
                callback: async (resp) => {
                    if (resp.error !== undefined) {
                        googleDocsFeedback.textContent = `❌ 認証エラー: ${resp.error}`;
                        throw (resp);
                    }
                    gapi.client.setToken(resp);
                    googleDocsFeedback.textContent = 'Googleドキュメントを作成中...';
                    await createGoogleDoc();
                },
            });

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        });

        async function createGoogleDoc() {
            try {
                googleDocsFeedback.textContent = '概要を生成中...';
                const summaryPrompt = `以下の議事録の要点を、ファイル名に使えるように20文字以内の短いタイトルで要約してください。例: 「新製品の販売戦略について」\n\n---\n${generatedMinutesText.value}`;
                const summary = await callGeminiAPI(summaryPrompt);

                const date = recordingStartTime;
                const yymmdd = date.getFullYear().toString().slice(-2) + ('0' + (date.getMonth() + 1)).slice(-2) + ('0' + date.getDate()).slice(-2);
                const company = clientCompany.value || '社外打合せ';
                
                const docTitle = `${yymmdd}_${company}_${summary.replace(/\n/g, '')}`;
                googleDocsFeedback.textContent = 'ドキュメントを作成中...';
                
                const createResponse = await gapi.client.docs.documents.create({ title: docTitle });
                const docId = createResponse.result.documentId;
                await gapi.client.docs.documents.batchUpdate({
                    documentId: docId,
                    requests: [{ insertText: { location: { index: 1 }, text: generatedMinutesText.value } }],
                });
                const docUrl = `https://docs.google.com/document/d/${docId}/edit`;
                googleDocsFeedback.innerHTML = `✅ <a href="${docUrl}" target="_blank" class="text-blue-500 hover:underline">Googleドキュメントが作成されました。</a>`;

            } catch (err) {
                googleDocsFeedback.textContent = `❌ エラー: ${err.message}`;
                console.error(err);
            }
        }

        // --- 初期化 ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = true;
            recognition.continuous = true;

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let currentFinalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        currentFinalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                if (currentFinalTranscript) {
                    finalTranscript += currentFinalTranscript + '\n';
                }
                transcriptionText.value = finalTranscript + interimTranscript;
                transcriptionText.scrollTop = transcriptionText.scrollHeight;
            };
            recognition.onstart = () => updateStatus('recording');
            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                } else {
                    updateStatus('idle');
                }
            };
            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error, event.message);
                let userMessage = `エラー: ${event.error}`;
                if (event.error === 'not-allowed') {
                    userMessage = 'マイクの使用が許可されていません。';
                    transcriptionText.value = 'マイクへのアクセスがブロックされました。\n\nブラウザやOSのマイク設定、またこのツールを埋め込んでいるサイトのiframe設定（allow="microphone"）を確認してください。';
                }
                updateStatus('error', userMessage);
                isRecording = false;
            };
        } else {
            startButton.disabled = true;
            updateStatus('error', 'ブラウザ非対応');
        }

        // --- ボタン操作 ---
        startButton.addEventListener('click', () => {
            isRecording = true;
            finalTranscript = '';
            transcriptionText.value = '';
            recordingStartTime = new Date();
            recognition.start();
            startButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            generationForm.classList.add('hidden');
            minutesContainer.classList.add('hidden');
        });

        stopButton.addEventListener('click', () => {
            isRecording = false;
            recognition.stop();
            stopButton.classList.add('hidden');
            startButton.classList.remove('hidden');
            if (transcriptionText.value.trim()) {
                generationForm.classList.remove('hidden');
            }
        });
        
        resetButton.addEventListener('click', () => {
            transcriptionText.value = '';
            attendees.value = '';
            clientCompany.value = '';
            clientAttendees.value = '';
            ourAttendees.value = '';
            generatedMinutesText.value = '';
            finalTranscript = '';
            minutesContainer.classList.add('hidden');
            generationForm.classList.add('hidden');
            startButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
            googleDocsFeedback.innerHTML = '';
            sendToGoogleDocsButton.classList.add('hidden');
            updateStatus('idle');
        });

        generateButton.addEventListener('click', async () => {
            let transcript = transcriptionText.value;
            if (!transcript.trim()) {
                alert('文字起こしされたテキストがありません。');
                return;
            }
            minutesContainer.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            generatedMinutesText.value = '';
            generateButton.disabled = true;

            // ★★★ 「ぞうほう」を「Zoho」に置換 ★★★
            transcript = transcript.replace(/ぞうほう/g, 'Zoho');

            const formattedStartTime = recordingStartTime.toLocaleString('ja-JP', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });

            const prompt = `あなたは優秀なアシスタントです。以下の会議情報と文字起こしテキストを基に、ビジネスで通用する議事録を作成してください。

# 会議情報
- 日時: ${formattedStartTime}
- 会社名: ${clientCompany.value || '記載なし'}
- 参加者 (相手先): ${clientAttendees.value || '記載なし'}
- 参加者 (自社): ${ourAttendees.value || '記載なし'}

# 文字起こしテキスト
---
${transcript}
---

# 生成する議事録のフォーマット
見出しは「【】」で囲み、箇条書きは「・」を使用してください。Markdownの「##」や「**」は使用しないでください。

【会議の概要】
・

【決定事項】
・

【アクションアイテム】
・担当者: 
・期限: 

【議論の詳細】
・`;

            try {
                const minutesText = await callGeminiAPI(prompt);
                generatedMinutesText.value = minutesText;
                sendToGoogleDocsButton.classList.remove('hidden');
            } catch (error) {
                generatedMinutesText.value = '議事録の生成中にエラーが発生しました。\n' + error.message;
            } finally {
                loadingSpinner.classList.add('hidden');
                generateButton.disabled = false;
                // ★★★ フォームを非表示にしない ★★★
                // generationForm.classList.add('hidden');
            }
        });
        
        async function callGeminiAPI(prompt) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'APIからの応答エラー');
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error('AIからの応答がありませんでした。');
            }
        }

        copyButton.addEventListener('click', () => {
            if (generatedMinutesText.value) {
                generatedMinutesText.select();
                document.execCommand('copy');
                alert('議事録をコピーしました。');
            }
        });

        function updateStatus(status, message = '') {
            const dot = statusElement.querySelector('.status-dot');
            const text = statusElement.querySelector('span');
            dot.className = 'status-dot w-3 h-3 rounded-full';
            switch (status) {
                case 'recording':
                    dot.classList.add('bg-green-500', 'status-dot-pulse');
                    text.textContent = '録音中...';
                    break;
                case 'error':
                    dot.classList.add('bg-red-500');
                    text.textContent = message;
                    break;
                case 'idle':
                default:
                    dot.classList.add('bg-gray-400');
                    text.textContent = '待機中';
                    break;
            }
        }
    </script>
</body>
</html>
