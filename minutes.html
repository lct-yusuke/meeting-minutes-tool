<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>議事録作成ツール</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section-title {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input[type="text"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .recording-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .btn-success {
            background: #43a047;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #388e3c;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-recording {
            background: #ffebee;
            color: #c62828;
            animation: pulse 2s infinite;
        }

        .status-idle {
            background: #f5f5f5;
            color: #666;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .recording-timer {
            font-size: 1.1em;
            font-weight: 600;
            color: #c62828;
        }

        .transcript-box {
            min-height: 150px;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
            line-height: 1.6;
            color: #333;
            max-height: 300px;
            overflow-y: auto;
        }

        .minutes-box {
            background: white;
            padding: 20px;
            border-radius: 5px;
            border: 2px solid #e0e0e0;
            min-height: 200px;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1em;
            max-height: 500px;
            overflow-y: auto;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background: #43a047;
        }

        .status-dot.disconnected {
            background: #e53935;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-weight: 500;
            margin: 10px 0;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .permission-info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .clear-btn {
            background: #ff5252;
            color: white;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .clear-btn:hover {
            background: #f44336;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎙️ 議事録作成ツール</h1>
        
        <div class="permission-info" id="permissionInfo">
            <strong>📢 初回利用時の注意:</strong><br>
            • 録音開始時にブラウザからマイクの使用許可を求められます<br>
            • 「許可」をクリックしてください<br>
            • Google Sitesでは一部機能が制限される場合があります
        </div>

        <div class="section">
            <h2 class="section-title">📋 基本情報</h2>
            <div class="input-group">
                <div class="input-field">
                    <label for="ourCompany">自社名</label>
                    <input type="text" id="ourCompany" value="リクト" placeholder="例: 株式会社ABC">
                </div>
                <div class="input-field">
                    <label for="theirCompany">先方会社名</label>
                    <input type="text" id="theirCompany" placeholder="例: 株式会社XYZ">
                </div>
                <div class="input-field">
                    <label for="ourAttendees">自社参加者</label>
                    <input type="text" id="ourAttendees" placeholder="例: 山田太郎, 佐藤花子">
                </div>
                <div class="input-field">
                    <label for="theirAttendees">先方参加者</label>
                    <input type="text" id="theirAttendees" placeholder="例: 田中一郎, 鈴木次郎">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">🎤 音声録音</h2>
            <div class="warning-message" id="browserWarning" style="display: none;">
                ⚠️ 音声認識はChromeブラウザで最適に動作します
            </div>
            <div class="recording-controls">
                <button id="startBtn" class="btn btn-primary">
                    <span>●</span> 録音開始
                </button>
                <button id="stopBtn" class="btn btn-secondary" disabled>
                    <span>■</span> 録音停止
                </button>
                <span id="status" class="status status-idle">待機中</span>
                <span id="recordingTimer" class="recording-timer" style="display: none;">00:00:00</span>
                <button id="clearBtn" class="btn clear-btn">
                    <span>🗑️</span> クリア
                </button>
            </div>
            <div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">
                <span>文字起こし内容 (文字数: <span id="charCount">0</span>)</span>
            </div>
            <div class="transcript-box" id="transcript">
                ここに文字起こしされた内容が表示されます...
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">⚙️ Google認証</h2>
            <div class="auth-status">
                <span class="status-dot disconnected" id="authStatusDot"></span>
                <span id="authStatusText">Google未認証</span>
            </div>
            <button id="authorizeBtn" class="btn btn-primary">
                Googleアカウントでログイン
            </button>
            <button id="signoutBtn" class="btn btn-secondary" style="display: none;">
                ログアウト
            </button>
            <div class="error-message message" id="authError"></div>
        </div>

        <div class="section">
            <h2 class="section-title">📄 議事録生成</h2>
            <button id="generateBtn" class="btn btn-primary" disabled>
                <span>✨</span> 議事録を生成
            </button>
            <div class="loading" id="generateLoading">
                <div class="spinner"></div>
                <span>議事録を生成中...</span>
            </div>
            <div class="error-message message" id="errorMessage"></div>
            <div class="success-message message" id="successMessage"></div>
            <div class="minutes-box" id="minutes" style="margin-top: 20px; display: none;">
                生成された議事録がここに表示されます...
            </div>
        </div>

        <div class="section" id="uploadSection" style="display: none;">
            <h2 class="section-title">☁️ Google Docsへアップロード</h2>
            <button id="uploadBtn" class="btn btn-success">
                <span>📤</span> Google Docsにアップロード
            </button>
            <div class="loading" id="uploadLoading">
                <div class="spinner"></div>
                <span>アップロード中...</span>
            </div>
        </div>
    </div>

    <script>
        // 設定 - 実際の値を設定してください
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // ここにGemini API Keyを設定
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // ここにGoogle OAuth Client IDを設定
        
        // グローバル変数
        let recognition = null;
        let isRecording = false;
        let fullTranscript = '';
        let interimTranscript = '';
        let accessToken = null;
        let tokenClient = null;
        let recordingStartTime = null;
        let recordingTimer = null;

        // DOM要素
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const generateBtn = document.getElementById('generateBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const authorizeBtn = document.getElementById('authorizeBtn');
        const signoutBtn = document.getElementById('signoutBtn');
        const clearBtn = document.getElementById('clearBtn');
        const transcriptDiv = document.getElementById('transcript');
        const minutesDiv = document.getElementById('minutes');
        const statusSpan = document.getElementById('status');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const authError = document.getElementById('authError');
        const authStatusDot = document.getElementById('authStatusDot');
        const authStatusText = document.getElementById('authStatusText');
        const recordingTimerSpan = document.getElementById('recordingTimer');
        const charCountSpan = document.getElementById('charCount');
        const browserWarning = document.getElementById('browserWarning');

        // ブラウザチェック
        function checkBrowser() {
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            if (!isChrome) {
                browserWarning.style.display = 'block';
            }
        }

        // 音声認識の初期化
        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    showError('お使いのブラウザは音声認識に対応していません。Chromeブラウザをご利用ください。');
                    startBtn.disabled = true;
                    return false;
                }

                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ja-JP';
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    console.log('音声認識開始');
                    isRecording = true;
                    statusSpan.textContent = '録音中...';
                    statusSpan.className = 'status status-recording';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    recordingStartTime = Date.now();
                    startRecordingTimer();
                    document.getElementById('permissionInfo').style.display = 'none';
                };

                recognition.onend = () => {
                    console.log('音声認識終了');
                    if (isRecording) {
                        // 録音中に認識が停止した場合は自動的に再開
                        setTimeout(() => {
                            if (isRecording) {
                                try {
                                    recognition.start();
                                } catch (e) {
                                    console.error('音声認識の再開に失敗:', e);
                                }
                            }
                        }, 500);
                    } else {
                        // 録音停止時の処理
                        statusSpan.textContent = '待機中';
                        statusSpan.className = 'status status-idle';
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        stopRecordingTimer();
                        
                        if (fullTranscript.trim()) {
                            generateBtn.disabled = false;
                        }
                    }
                };

                recognition.onresult = (event) => {
                    interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        
                        if (event.results[i].isFinal) {
                            fullTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    updateTranscriptDisplay();
                };

                recognition.onerror = (event) => {
                    console.error('音声認識エラー:', event.error);
                    
                    if (event.error === 'not-allowed') {
                        showError('マイクへのアクセスが拒否されました。ブラウザの設定でマイクの使用を許可してください。');
                        stopRecording();
                    } else if (event.error === 'no-speech') {
                        console.log('無音を検出しました');
                    } else if (event.error === 'network') {
                        showError('ネットワークエラーが発生しました。');
                    }
                };

                return true;
            } catch (error) {
                console.error('音声認識の初期化エラー:', error);
                showError('音声認識の初期化に失敗しました。');
                return false;
            }
        }

        // 文字起こし表示の更新
        function updateTranscriptDisplay() {
            transcriptDiv.textContent = fullTranscript + interimTranscript;
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
            charCountSpan.textContent = (fullTranscript + interimTranscript).length;
        }

        // 録音タイマー
        function startRecordingTimer() {
            recordingTimerSpan.style.display = 'inline';
            recordingTimer = setInterval(updateRecordingTimer, 1000);
        }

        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            recordingTimerSpan.style.display = 'none';
        }

        function updateRecordingTimer() {
            if (!recordingStartTime) return;
            
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            recordingTimerSpan.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 録音停止
        function stopRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
        }

        // Google API初期化
        function initGoogleAPI() {
            if (typeof google === 'undefined' || !google.accounts) {
                console.error('Google APIが読み込まれていません');
                showAuthError('Google APIの読み込みに失敗しました。ページを再読み込みしてください。');
                return;
            }

            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file',
                    callback: async (response) => {
                        if (response.error !== undefined) {
                            showAuthError('Google認証に失敗しました: ' + response.error);
                            return;
                        }
                        accessToken = response.access_token;
                        
                        // ユーザー情報を取得して社内メンバーかチェック
                        try {
                            const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`
                                }
                            });
                            const userData = await userInfo.json();
                            
                            // 特定のドメインのみ許可（例：@yourcompany.com）
                            const ALLOWED_DOMAINS = ['yourcompany.com', 'gmail.com']; // 許可するドメインを設定
                            const emailDomain = userData.email.split('@')[1];
                            
                            if (!ALLOWED_DOMAINS.includes(emailDomain)) {
                                showAuthError('このツールは社内メンバーのみ利用可能です。');
                                accessToken = null;
                                return;
                            }
                            
                            updateAuthStatus(true);
                            showSuccess(`Google認証に成功しました (${userData.email})`);
                        } catch (error) {
                            console.error('ユーザー情報取得エラー:', error);
                            showAuthError('ユーザー情報の取得に失敗しました。');
                        }
                    },
                    hosted_domain: 'yourcompany.com' // 特定のドメインに制限する場合
                });
            } catch (error) {
                console.error('Google API初期化エラー:', error);
                showAuthError('Google APIの初期化に失敗しました。');
            }
        }

        // 認証状態の更新
        function updateAuthStatus(isAuthenticated) {
            if (isAuthenticated) {
                authStatusDot.className = 'status-dot connected';
                authStatusText.textContent = 'Google認証済み';
                authorizeBtn.style.display = 'none';
                signoutBtn.style.display = 'inline-block';
                if (minutesDiv.textContent && minutesDiv.textContent !== '生成された議事録がここに表示されます...') {
                    document.getElementById('uploadSection').style.display = 'block';
                }
            } else {
                authStatusDot.className = 'status-dot disconnected';
                authStatusText.textContent = 'Google未認証';
                authorizeBtn.style.display = 'inline-block';
                signoutBtn.style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
                accessToken = null;
            }
        }

        // Gemini APIで議事録生成
        async function generateMinutes() {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                showError('Gemini API Keyが設定されていません。');
                return;
            }

            if (!fullTranscript.trim()) {
                showError('文字起こしされた内容がありません');
                return;
            }

            document.getElementById('generateLoading').classList.add('active');
            generateBtn.disabled = true;
            hideMessages();

            const ourCompany = document.getElementById('ourCompany').value || 'リクト';
            const theirCompany = document.getElementById('theirCompany').value || '先方';
            const ourAttendees = document.getElementById('ourAttendees').value || '自社参加者';
            const theirAttendees = document.getElementById('theirAttendees').value || '先方参加者';

            const prompt = `
以下の会議の文字起こしから議事録を作成してください。

【会議情報】
日時: ${new Date().toLocaleString('ja-JP')}
自社: ${ourCompany}
先方: ${theirCompany}
自社参加者: ${ourAttendees}
先方参加者: ${theirAttendees}

【文字起こし内容】
${fullTranscript}

【議事録形式】
以下の形式で議事録を作成してください：

1. 会議概要
   - 日時
   - 参加者（自社・先方）
   - 議題

2. 議論内容（要点を箇条書きで）

3. 決定事項
   - 明確に決定された事項を箇条書きで記載
   - 各項目は具体的で実行可能な内容にする

4. ネクストアクション
   - 誰が（担当者名）
   - いつまでに（具体的な期限）
   - 何をするか（具体的な行動）
   - 優先度（高/中/低）

5. 今後の予定
   - 次回会議の予定
   - マイルストーン

6. 備考・補足事項
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 4096,
                        }
                    }),
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'APIリクエストに失敗しました');
                }
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const minutes = data.candidates[0].content.parts[0].text;
                    minutesDiv.textContent = minutes;
                    minutesDiv.style.display = 'block';
                    showSuccess('議事録の生成が完了しました');
                    
                    if (accessToken) {
                        document.getElementById('uploadSection').style.display = 'block';
                    }
                } else {
                    throw new Error('議事録の生成に失敗しました');
                }
            } catch (error) {
                showError('エラー: ' + error.message);
                console.error('議事録生成エラー:', error);
            } finally {
                document.getElementById('generateLoading').classList.remove('active');
                generateBtn.disabled = false;
            }
        }

        // Google Docsへアップロード
        async function uploadToGoogleDocs() {
            if (!accessToken) {
                showError('Googleアカウントにログインしてください');
                return;
            }

            const minutes = minutesDiv.textContent;
            if (!minutes || minutes === '生成された議事録がここに表示されます...') {
                showError('アップロードする議事録がありません');
                return;
            }

            document.getElementById('uploadLoading').classList.add('active');
            uploadBtn.disabled = true;
            hideMessages();

            try {
                // Google Docs APIを使用してドキュメントを作成
                const createResponse = await fetch('https://docs.googleapis.com/v1/documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: `議事録_${new Date().toLocaleString('ja-JP').replace(/[/:]/g, '-')}`
                    }),
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error?.message || 'ドキュメントの作成に失敗しました');
                }

                const doc = await createResponse.json();
                const documentId = doc.documentId;

                // ドキュメントに内容を挿入
                const updateResponse = await fetch(`https://docs.googleapis.com/v1/documents/${documentId}:batchUpdate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requests: [{
                            insertText: {
                                location: { index: 1 },
                                text: minutes
                            }
                        }]
                    }),
                });

                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.error?.message || 'ドキュメントの更新に失敗しました');
                }

                showSuccess(`議事録をGoogle Docsにアップロードしました。<br><a href="https://docs.google.com/document/d/${documentId}/edit" target="_blank" style="color: #1976d2;">ドキュメントを開く</a>`);
            } catch (error) {
                showError('アップロードエラー: ' + error.message);
                console.error('アップロードエラー:', error);
            } finally {
                document.getElementById('uploadLoading').classList.remove('active');
                uploadBtn.disabled = false;
            }
        }

        // メッセージ表示関数
        function showError(message) {
            errorMessage.innerHTML = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            successMessage.innerHTML = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            authError.style.display = 'none';
        }

        // イベントリスナー
        startBtn.addEventListener('click', async () => {
            console.log('録音開始ボタンがクリックされました');
            
            if (!recognition) {
                showError('音声認識が初期化されていません。ページを再読み込みしてください。');
                return;
            }

            try {
                // マイクの許可を明示的に要求
                await navigator.mediaDevices.getUserMedia({ audio: true });
                recognition.start();
            } catch (error) {
                console.error('録音開始エラー:', error);
                if (error.name === 'NotAllowedError') {
                    showError('マイクへのアクセスが拒否されました。ブラウザの設定でマイクの使用を許可してください。');
                } else if (error.name === 'NotFoundError') {
                    showError('マイクが見つかりません。マイクが接続されている
